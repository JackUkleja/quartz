<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="For the last few months I&rsquo;ve had Windows 7 RC installed on two home computers, and both of them have exhibited a strange problem: They would randomly wake from sleep ."><meta property="og:title" content="Fix for Windows 7 &#34;random wake from sleep&#34; problem"><meta property="og:description" content="For the last few months I&rsquo;ve had Windows 7 RC installed on two home computers, and both of them have exhibited a strange problem: They would randomly wake from sleep ."><meta property="og:type" content="website"><meta property="og:image" content="https://jackukleja.github.io/quartz/icon.png"><meta property="og:url" content="https://jackukleja.github.io/quartz/fix-for-windows-7-random-wake-from-sleep-problem/"><meta property="og:width" content="200"><meta property="og:height" content="200"><meta name=twitter:card content="summary"><meta name=twitter:title content="Fix for Windows 7 &#34;random wake from sleep&#34; problem"><meta name=twitter:description content="For the last few months I&rsquo;ve had Windows 7 RC installed on two home computers, and both of them have exhibited a strange problem: They would randomly wake from sleep ."><meta name=twitter:image content="https://jackukleja.github.io/quartz/icon.png"><meta name=twitter:site content="jackukleja"><title>Fix for Windows 7 "random wake from sleep" problem</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://jackukleja.github.io/quartz//icon.png><link href=https://jackukleja.github.io/quartz/styles.cc7f6af4b1c55e03de1a74f24f2d2447.min.css rel=stylesheet><link href=https://jackukleja.github.io/quartz/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script async src="https://www.googletagmanager.com/gtag/js?id=G-1L3KMW61R9"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-1L3KMW61R9",{anonymize_ip:!1})}</script><script src=https://jackukleja.github.io/quartz/js/darkmode.d9c64296ad395fdb6dcbc6ac0b76d34f.min.js></script>
<script src=https://jackukleja.github.io/quartz/js/util.89a7b555e7f893ee42c640e63d82c383.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/core@1.2.1></script>
<script src=https://cdn.jsdelivr.net/npm/@floating-ui/dom@1.2.1></script>
<script defer src=https://jackukleja.github.io/quartz/js/popover.f03552ccb84d99ca615d1cfb9abde59e.min.js></script>
<script defer src=https://jackukleja.github.io/quartz/js/code-title.ce4a43f09239a9efb48fee342e8ef2df.min.js></script>
<script defer src=https://jackukleja.github.io/quartz/js/clipboard.2913da76d3cb21c5deaa4bae7da38c9f.min.js></script>
<script defer src=https://jackukleja.github.io/quartz/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!1,PRODUCTION=!0,BASE_URL="https://jackukleja.github.io/quartz/",fetchData=Promise.all([fetch("https://jackukleja.github.io/quartz/indices/linkIndex.e77416d15b21f300430f657f3a41b113.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://jackukleja.github.io/quartz/indices/contentIndex.32d726482842bc672ea272735e35c492.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts(),initPopover("https://jackukleja.github.io/quartz",!0);const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://jackukleja.github.io/quartz",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=()=>{addCopyButtons(),addTitleToCodeBlocks()}</script><script type=module>
    import { attachSPARouting } from "https:\/\/jackukleja.github.io\/quartz\/js\/router.d6fe6bd821db9ea97f9aeefae814d8e7.min.js"
    attachSPARouting(init, render)
  </script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://jackukleja.github.io/quartz/js/full-text-search.e6e2e0c213187ca0c703d6e2c7a77fcd.min.js></script><div class=singlePage><header><h1 id=page-title><a class=root-title href=https://jackukleja.github.io/quartz/>Jack Ukleja | Notes</a></h1><div class=spacer></div><div id=search-icon><p>Search</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Fix for Windows 7 "random wake from sleep" problem</h1><p class=meta>Last updated
Aug 7, 2009</p><ul class=tags></ul><p>For the last few months I&rsquo;ve had Windows 7 RC installed on two home computers, and both of them have exhibited a strange problem: They would randomly wake from sleep .</p><p>The computers would often wake up just seconds after being shut down. At other times they would wake up in the middle of the night. To make matters worse one PC, which had recently had its graphics card upgraded, would go into an endless loop of restarting without ever getting to the Windows login screen. I suspected a power problem relating to the new card.</p><p>I spent quite some time investigating these wake problems (which I believed were unrelated) but could not diagnose the issue. Eventually I gave up and had to disable sleep on both machines (which pained me greatly!).</p><p>[ad#Google Adsense #1]</p><p>Last week I had a second wind and was determined to resolve this problem once and for all. I figured there must be a tool that could tell me what caused the wake up events, and after some research I discovered the Vista/Windows 7
<a href=http://technet.microsoft.com/en-us/library/cc748940%28WS.10%29.aspx rel=noopener>powercfg</a> tool.</p><p>To use this tool you simply type <strong>powercfg –lastwake</strong> at the command prompt</p><img style="display:inline;border:0 initial initial" title="powercfg with lastwake command" src=https://s3-us-west-2.amazonaws.com/jack-ukleja-com/powercfg1.png border=0 alt=powercfg width=681 height=226><p>In the above screenshot you can see the computer was woken by something on the USB hub (my mouse in this case). But much to my annoyance, when I ran this tool after a phantom wake it reported the type was “Unknown”!</p><p>Because I had a suspicion this could be a wake-on-lan (WOL) behaviour I used the
<a href=http://www.wireshark.org/ rel=noopener>WireShark</a> network analysis tool to monitor network traffic for WOL packets. Perhaps a third computer had been infected with malware and was trying to wake other computers to have its wicked way? Unfortunately nothing showed up on the wire.</p><p>No further progress was made until I randomly stumbled across a forum posting about a network adaptor setting called &ldquo;<strong>Wake on pattern match</strong>&rdquo;. I checked both my PCs and this setting <span style=text-decoration:underline>was</span> enabled. It appears this obscure setting is <strong>enabled by default in Windows 7</strong> for Realtek RTL8168B/8111B and RTL8168C(P)/8111C(P) Family Gigabit Ethernet NICs**.**</p><p>What does &ldquo;Wake on pattern match&rdquo; actually do?</p><p>[ad#Google Adsense #1]</p><p>Most people are familiar with Wake-on-LAN which uses a &ldquo;magic packet&rdquo; (hard-coded) to trigger a wake event. Well it seems that feature has been superseded by the more flexible &ldquo;Wake on pattern match&rdquo; capability. According to this
<a href=http://www.microsoft.com/whdc/archive/netpm.mspx rel=noopener>Microsoft Article on Power Management for Network Devices</a>:</p><blockquote>The packet patterns that define the wake-up frames [for "wake on pattern match"] are provided to the NDIS 5.0 miniport driver by the operating system. At runtime, the protocol sets the wake-up policy using OIDs. These are, for example, <em>Enable Wakeup</em><em>Set Packet Pattern</em><em>Remove Packet Pattern</em>. Currently, the Microsoft TCP/IP is the only Microsoft protocol stack that supports network power management. <strong>It will register the following packet patterns at miniport initialization</strong>:<ul><li>Directed Layer Two packet</li><li>Address resolution protocol (ARP) broadcast for station IP address (frames with DIX header)</li><li>NetBIOS over TCP/IP broadcast for station's assigned <em>computername</em> (frames with DIX header)</li></ul></blockquote>I am no networking expert but the last two sound like they could be pretty common activities on your typical home network. If so it's no wonder my computers were exhibiting such crazy wakeup symptoms. (Either that or I have got a renegade PC on my networking sending out these packets).<p>The solution? Simply disable the &ldquo;Wake on pattern match&rdquo; setting under the network adaptors advanced properties tab, as shown below:</p><p><a href=https://s3-us-west-2.amazonaws.com/jack-ukleja-com/realtek_wake_on_pattern_match.png rel=noopener></a></p><p>My biggest mistake? I could have short circuited the resolution of this problem by testing my computers without the Ethernet cable plugged in right at the start. The reason I didn&rsquo;t was I couldn&rsquo;t understand how a WOL packet could possibly be being sent so I ignored the possibility.</p><p>Now I know about &ldquo;Wake on pattern match&rdquo;, next time I will be prepared.</p><p>[ad#Google Adsense #1]</p></article><hr><div class=page-end id=footer><div class=backlinks-container><h3>Backlinks</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>Interactive Graph</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://jackukleja.github.io/quartz/js/graph.164140c975095546a64a642f726e55c7.js></script></div></div><div id=contact_buttons><footer><p>Made by Jack Ukleja using <a href=https://github.com/jackyzha0/quartz>Quartz</a>, © 2023</p><ul><li><a href=https://jackukleja.github.io/quartz/>Home</a></li><li><a href=https://twitter.com/jackukleja>Twitter</a></li></ul></footer></div></div></body></html>